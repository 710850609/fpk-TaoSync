name: Build and publish fpk for multiple architectures

on:
  push:
    tags:
      - '*'
  workflow_dispatch: {}

permissions:
  contents: write

env:
  NODE_VERSION: "14.x"
  PYTHON_VERSION: '3.11'

jobs:
  check-arm:
    runs-on: ubuntu-latest-arm
    timeout-minutes: 2
    steps:
      - name: Check if ARM runner is available
        run: |
          echo "ARM runner connected!"
          echo "Architecture: $(uname -m)"
          echo "CPU info:"
          lscpu || echo "lscpu not available"
  check-arm64:
    runs-on: ubuntu-latest-arm64
    timeout-minutes: 2
    steps:
      - name: Check if ARM64 runner is available
        run: |
          echo "ARM64 runner connected!"
          echo "Architecture: $(uname -m)"
          echo "CPU info:"
          lscpu || echo "lscpu not available"          
  # 主 job，负责设置变量
  setup:
    needs: [check-arm, check-arm64]
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set-tag.outputs.tag }}
      prerelease: ${{ steps.set-tag.outputs.prerelease }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set tag and prerelease info
        id: set-tag
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF##*/}"
          else
            TAG="run-${GITHUB_RUN_NUMBER}"
          fi
          
          if [[ "$TAG" == run-* ]] || [[ "${TAG}" == *dev* ]] || [[ "${TAG}" == *pre* ]] || [[ "${TAG}" == *beta* ]]; then
            PRE=true
          else
            PRE=false
          fi
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "prerelease=$PRE" >> $GITHUB_OUTPUT

  # 架构构建模板
  build-arch:
    needs: setup
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-latest-arm64
          - arch: arm
            runner: ubuntu-latest-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Show architecture info
        run: |
          echo "当前架构: $(uname -m)"
          echo "构建目标: ${{ matrix.arch }}"

      - name: Run build
        run: |
          echo "开始构建fpk for ${{ matrix.arch }}"
          export BUILD_ARCH=${{ matrix.arch }}
          export BUILD_TARGET=linux-${{ matrix.arch }}
          
          chmod +x ./fnpack.sh 2>/dev/null || true
          chmod +x ./build.sh 2>/dev/null || true
          
          if [ -f "./build.sh" ]; then
            ./build.sh all
          else
            echo "使用默认构建命令"
          fi

      - name: Prepare artifact
        run: |
          FPK_FILE=$(ls *.fpk 2>/dev/null | head -1)
          if [ -z "$FPK_FILE" ]; then
            echo "错误：未找到.fpk文件"
            ls -la
            exit 1
          fi
          
          mkdir -p release
          NEW_FPK_NAME="TaoSync-linux-${{ matrix.arch }}.fpk"
          cp "$FPK_FILE" "release/$NEW_FPK_NAME"
          echo "准备完成: $NEW_FPK_NAME"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fpk-${{ matrix.arch }}
          path: release/
          retention-days: 7

  create-release:
    needs: [setup, build-arch]
    runs-on: ubuntu-latest
    steps:
      - name: Create release directory
        run: |
          mkdir -p combined-release

      - name: Download all artifacts
        run: |
          # 下载所有架构的产物
          for arch in amd64 arm arm64; do
            echo "下载 $arch 架构的构建产物..."
            if actions/download-artifact@v4 --name fpk-$arch --path combined-release 2>/dev/null; then
              echo "成功下载 $arch"
            else
              echo "警告：$arch 架构构建产物不存在"
            fi
            sleep 1
          done

      - name: Prepare release bundle
        run: |
          echo "收集到的构建产物:"
          ls -la combined-release/
          
          # 移动文件到根目录
          find combined-release -name "*.fpk" -exec mv {} combined-release/ \;
          rm -rf combined-release/release 2>/dev/null || true
          
          # 创建README
          cat > combined-release/README.md << EOF
          # TaoSync 多架构发布包
          
          版本: ${{ needs.setup.outputs.tag }}
          
          包含的架构:
          EOF
          
          for fpk in combined-release/*.fpk; do
            if [ -f "$fpk" ]; then
              fname=$(basename "$fpk")
              echo "- $fname" >> combined-release/README.md
            fi
          done
          
          cat >> combined-release/README.md << EOF
          
          根据您的设备架构选择对应的文件。
          EOF

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.setup.outputs.tag }}
          name: Release ${{ needs.setup.outputs.tag }}
          artifacts: "combined-release/*"
          prerelease: ${{ needs.setup.outputs.prerelease }}
          skipIfReleaseExists: true
          token: ${{ secrets.GITHUB_TOKEN }}