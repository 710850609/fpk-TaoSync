name: Build and publish fpk

on:
  push:
    tags:
      - '*'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 14.x
        uses: actions/setup-node@v4
        with:
          node-version: "14.x"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Download and setup fnpack
        run: |
          echo "下载fnpack"
          wget -O fnpack "https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64"
          chmod +x fnpack
          # 将 fnpack 移动到可执行目录
          sudo mv fnpack /usr/local/bin/

      - name: Run build package
        run: |
          echo "开始构建fpk"
          chmod +x ./build.sh || true
          ./build.sh all

      - id: package
        name: Find and prepare .fpk file
        run: |
          # 查找构建生成的.fpk文件
          FPK_FILE=$(ls *.fpk 2>/dev/null | head -1)
          
          if [ -z "$FPK_FILE" ]; then
            echo "错误：未找到.fpk文件"
            ls -la
            exit 1
          fi
          
          echo "找到FPK文件: $FPK_FILE"
          
          # 创建release目录
          mkdir -p release
          
          # 复制到release目录
          cp "$FPK_FILE" "release/TaoSync.fpk"
          
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF##*/}"
          else
            TAG="run-${GITHUB_RUN_NUMBER}"
          fi
          
          # prerelease only when tag ends with -pre
          if [[ "${TAG}" =~ -pre$ ]]; then
            PRE=true
          else
            PRE=false
          fi
          
          echo "fpk_name=$FPK_FILE" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "prerelease=${PRE}" >> $GITHUB_OUTPUT
          echo "fpk_path=release/$FPK_FILE" >> $GITHUB_OUTPUT

      - name: Upload .fpk as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: fpk
          path: "release/*.fpk"

      - name: Create GitHub Release and upload asset
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.package.outputs.tag }}
          name: ${{ steps.package.outputs.tag }}
          artifacts: "release/*.fpk"
          prerelease: ${{ steps.package.outputs.prerelease }}
          skipIfReleaseExists: true
          token: ${{ secrets.GITHUB_TOKEN }}