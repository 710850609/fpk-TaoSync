name: test build

on:
  push:
    tags:
      - '*'
  workflow_dispatch: {}

permissions:
  contents: write

env:
  NODE_VERSION: "18"
  PYTHON_VERSION: '3.11'

jobs:  
  # 主 job，负责设置变量
  setup:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set-tag.outputs.tag }}
      prerelease: ${{ steps.set-tag.outputs.prerelease }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set tag and prerelease info
        id: set-tag
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF##*/}"
          else
            TAG="run-${GITHUB_RUN_NUMBER}"
          fi
          
          if [[ "$TAG" == run-* ]] || [[ "${TAG}" == *dev* ]] || [[ "${TAG}" == *pre* ]] || [[ "${TAG}" == *beta* ]]; then
            PRE=true
          else
            PRE=false
          fi
          
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "prerelease=$PRE" >> $GITHUB_OUTPUT

  build-amd64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run build
        run: |          
          chmod +x ./fnpack.sh 2>/dev/null || true
          chmod +x ./build.sh 2>/dev/null || true
          ./build.sh 2>/dev/null || true

      - name: Prepare artifact
        run: |
          FPK_FILE=$(ls *.fpk 2>/dev/null | head -1)
          if [ -z "$FPK_FILE" ]; then
            echo "错误：未找到.fpk文件"
            ls -la
            exit 1
          fi
          
          mkdir -p release
          NEW_FPK_NAME="TaoSync-linux-amd64.fpk"
          cp "$FPK_FILE" "release/$NEW_FPK_NAME"
          echo "准备完成: $NEW_FPK_NAME"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fpk-amd64
          path: release/
          retention-days: 1

      - name: Upload taosync-source artifact
        uses: actions/upload-artifact@v4
        with:
          name: taosync-source
          path: taosync-source
          retention-days: 1

  # 所有架构都使用 Docker 在 x86 上构建
  build-arch:
    needs: 
      - setup
      - build-amd64
    runs-on: ubuntu-latest  # 所有架构都在 x86 上运行
    strategy:
      matrix:
        include:
          - arch: arm64
            docker_image: "arm64v8/python:3.11"
            platform: "linux/arm64/v8"
          - arch: arm
            docker_image: "arm32v7/python:3.11"
            platform: "linux/arm/v7"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: download taosync-source artifact
        uses: actions/download-artifact@v4
        with:
          name: taosync-source
          path: taosync-source

      - name: remove wheels 
        run: |
          echo "当前目录$(pwd)"
          echo "当前资源$(ls -la)"
          rm -rf taosync-source/wheels 2>/dev/null || true

      - name: Setup QEMU for ARM emulation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.platform }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Docker build script
        run: |
          echo "目标架构: ${{ matrix.arch }}"
          cat > docker-build.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "=== 在 Docker 中构建 $BUILD_ARCH 架构 ==="
          echo "当前架构: $(uname -m)"
          echo "Python 版本: $(python3 --version)"
          echo "Node 版本: $(node --version)"
          echo "当前目录$(pwd)"
          echo "当前资源$(ls -la)"
          
          # 更新系统并安装依赖
          apt-get update
          apt-get install -y \
            rsync \
            python3-pip
          
          # 执行构建脚本
          chmod +x ./fnpack.sh 2>/dev/null || true
          chmod +x ./build.sh 2>/dev/null || true
          ./build.sh 2>/dev/null || true
          
          # 验证构建结果
          FPK_FILE=$(ls *.fpk 2>/dev/null | head -1)
          if [ -z "$FPK_FILE" ]; then
            echo "错误：未找到.fpk文件"
            ls -la
            exit 1
          fi
          
          echo "构建完成: $FPK_FILE"
          EOF
          
          chmod +x docker-build.sh

      - name: Build in Docker container
        run: |
          echo "使用 Docker 构建 ${{ matrix.arch }} 架构"
          
          # 清理之前的构建文件
          rm -f *.fpk 2>/dev/null || true
          rm -rf release 2>/dev/null || true
          
          # 运行 Docker 构建
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v "$PWD:/workspace" \
            -w /workspace \
            ${{ matrix.docker_image }} \
            /bin/bash -c "
              cd /workspace
              ./docker-build.sh
              
              # 复制构建产物到宿主机可访问的位置
              mkdir -p /output
              FPK_FILE=\$(ls *.fpk 2>/dev/null | head -1)
              if [ -n \"\$FPK_FILE\" ]; then
                cp \"\$FPK_FILE\" /output/
                echo \"已复制产物: \$FPK_FILE\"
              else
                echo '错误：未找到构建产物'
                exit 1
              fi
            "

      - name: Prepare artifact
        run: |
          echo "准备 ${{ matrix.arch }} 架构的产物"
          
          # 从临时输出目录获取文件
          if [ -f "output/*.fpk" ]; then
            FPK_FILE=$(ls output/*.fpk | head -1)
            mkdir -p release
            NEW_FPK_NAME="TaoSync-linux-${{ matrix.arch }}.fpk"
            cp "$FPK_FILE" "release/$NEW_FPK_NAME"
            
            # 验证文件
            echo "产物信息:"
            file "release/$NEW_FPK_NAME" || true
            ls -lh "release/$NEW_FPK_NAME"
            
            echo "准备完成: $NEW_FPK_NAME"
          else
            # 尝试直接查找
            FPK_FILE=$(ls *.fpk 2>/dev/null | head -1)
            if [ -n "$FPK_FILE" ]; then
              mkdir -p release
              NEW_FPK_NAME="TaoSync-linux-${{ matrix.arch }}.fpk"
              cp "$FPK_FILE" "release/$NEW_FPK_NAME"
              echo "准备完成: $NEW_FPK_NAME"
            else
              echo "错误：未找到构建产物"
              ls -la
              exit 1
            fi
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fpk-${{ matrix.arch }}
          path: release/
          retention-days: 1

      - name: Cleanup
        run: |
          rm -rf output release *.fpk docker-build.sh 2>/dev/null || true

  create-release:
    needs: 
      - setup
      - build-arch
    runs-on: ubuntu-latest
    steps:
      - name: Create release directory
        run: |
          mkdir -p combined-release
    
      - name: Download amd64 artifact
        uses: actions/download-artifact@v4
        with:
          name: fpk-amd64
          path: combined-release

      - name: Download arm artifact
        uses: actions/download-artifact@v4
        with:
          name: fpk-arm
          path: combined-release

      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: fpk-arm64
          path: combined-release


      - name: Download all artifacts
        run: |
          echo "下载所有架构的构建产物..."
          
          for arch in amd64 arm arm64; do
            echo "处理 $arch 架构..."
            
            # 首先尝试主构建产物
            if actions/download-artifact@v4 --name fpk-$arch --path combined-release 2>/dev/null; then
              echo "✓ 使用主构建产物: $arch"
            # 然后尝试回退产物
            elif actions/download-artifact@v4 --name fpk-$arch-fallback --path combined-release 2>/dev/null; then
              echo "✓ 使用回退构建产物: $arch"
            else
              echo "✗ 警告：$arch 架构构建产物不存在"
            fi
            
            sleep 1
          done

      - name: Prepare release bundle
        run: |
          echo "收集到的构建产物:"
          ls -la combined-release/
          
          # 移动所有 .fpk 文件到根目录
          find combined-release -name "*.fpk" -exec mv {} combined-release/ \;
          
          # 清理子目录
          rm -rf combined-release/*/ 2>/dev/null || true
          
          # 重命名文件以确保一致性
          for file in combined-release/*.fpk; do
            if [ -f "$file" ]; then
              BASENAME=$(basename "$file")
              # 确保文件名符合我们的命名规范
              if [[ ! "$BASENAME" =~ ^TaoSync-linux- ]]; then
                # 从文件名提取架构信息
                if [[ "$BASENAME" =~ linux-amd64 ]]; then
                  NEW_NAME="TaoSync-linux-amd64.fpk"
                elif [[ "$BASENAME" =~ linux-arm64 ]]; then
                  NEW_NAME="TaoSync-linux-arm64.fpk"
                elif [[ "$BASENAME" =~ linux-arm ]]; then
                  NEW_NAME="TaoSync-linux-arm.fpk"
                else
                  # 无法识别，保持原名
                  NEW_NAME="$BASENAME"
                fi
                mv "$file" "combined-release/$NEW_NAME"
                echo "重命名: $BASENAME -> $NEW_NAME"
              fi
            fi
          done
          
          echo "最终发布文件:"
          ls -lh combined-release/

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.setup.outputs.tag }}
          name: ${{ needs.setup.outputs.tag }}
          artifacts: "combined-release/*"
          prerelease: ${{ needs.setup.outputs.prerelease }}
          skipIfReleaseExists: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release summary
        if: always()
        run: |
          echo "=== 发布总结 ==="
          echo "版本: ${{ needs.setup.outputs.tag }}"
          echo "预发布: ${{ needs.setup.outputs.prerelease }}"
          echo "包含的文件:"
          ls -la combined-release/
          echo "================"