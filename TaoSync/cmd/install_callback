#!/bin/bash

### This script is called after the user installs the application.
LOG_FILE="${TRIM_PKGVAR}/info.log"
SCRIPT_PATH="${TRIM_APPDEST}/server"
DATA_PATH="${TRIM_PKGVAR}"
CFG_FILE="${DATA_PATH}/data/config.ini"

log_msg() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> ${LOG_FILE}
}

check_port_in_use() {
    local port=$1
    # Linux 用 ss，没有 ss 再用 netstat
    if command -v ss >/dev/null 2>&1; then
        ss -tln | grep -q ":$port "
    elif command -v netstat >/dev/null 2>&1; then
        netstat -tln | grep -q ":$port "
    else
        # 都检测不到就保守一点：当“未占用”继续往下走
        return 1
    fi
}

# 检查目标端口
if [ "$TAO_PORT" -lt 1024 ]; then
    log_msg "目标端口 $TAO_PORT 小于 1024，属于系统保留端口，请选择 1024–65535 之间的端口"
    echo "端口 $TAO_PORT 为系统保留端口，请选择 1024–65535 之间的端口" > "${TRIM_TEMP_LOGFILE}"
    exit 1
fi
if check_port_in_use "$TAO_PORT"; then
    log_msg "目标端口 $TAO_PORT 已被占用"
    # 在应用启动、安装、更新等过程中遇到错误时，可以向 TRIM_TEMP_LOGFILE 写入错误信息，然后退出脚本并返回错误码 1
    # 系统会自动将错误日志在前端展示为用户可见的内容（Dialog对话框形式）
    echo "端口 $TAO_PORT 已被占用，请改用其他端口" > "${TRIM_TEMP_LOGFILE}"
    exit 1
else
    log_msg "端口 $TAO_PORT 检查未被占用"    
fi


log_msg "创建虚拟环境"
bash -c "/usr/bin/python3 -m venv ${SCRIPT_PATH}/.venv" >> ${LOG_FILE} 2>&1

# log_msg "激活虚拟环境"
# bash -c "source ${SCRIPT_PATH}/.venv/bin/activate" >> ${LOG_FILE} 2>&1

log_msg "安装离线依赖"
bash -c "${SCRIPT_PATH}/.venv/bin/pip install --no-index --find-links=${SCRIPT_PATH}/wheels -r ${SCRIPT_PATH}/requirements.txt" >> ${LOG_FILE} 2>&1

log_msg "创建前端目录引用"
bash -c "ln -sf ${SCRIPT_PATH}/front  ${DATA_PATH}/front" >> ${LOG_FILE} 2>&1

log_msg "设置admin账户: ${wizard_admin_username}"
bash -c "cd ${DATA_PATH} && ${SCRIPT_PATH}/.venv/bin/python3 ${SCRIPT_PATH}/update_admin.py ${wizard_admin_username} ${wizard_admin_password}" 2>> ${LOG_FILE} 2>&1
log_msg "已设置admin账号、密码"

log_msg "复制默认配置"
if [ ! -f "${CFG_FILE}" ]; then
    bash -c "cp ${SCRIPT_PATH}/config.ini ${CFG_FILE}" >> ${LOG_FILE} 2>&1
    log_msg "已复制默认配置文件到 ${CFG_FILE}"
else
    log_msg "配置文件已存在，跳过复制默认配置"
fi

# 修改配置文件中的端口号
log_msg "修改配置文件中的端口: ${TAO_PORT}"
sed -i "s|^[[:space:]]*port[[:space:]]*=.*|port=${TAO_PORT}|" "${CFG_FILE}"

# 修改配置文件中的任务超时时间
log_msg "修改配置文件中的任务超时时间: ${TAO_TASK_TIMEOUT}"
sed -i "s|^[[:space:]]*task_timeout[[:space:]]*=.*|task_timeout=${TAO_TASK_TIMEOUT}|" "${CFG_FILE}"

exit 0